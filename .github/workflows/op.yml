name: N1 OpenWRT RootFS Custom Build

on:
  # âœ… æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      OP_author:
        description: 'ç¼–è¯‘è€…åç§°'
        required: false
        default: 'GitHub Actions'

  # âœ… æ¯ 15 å¤©è‡ªåŠ¨è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨ 3:00ï¼‰
  schedule:
    - cron: '0 19 */15 * *'  # UTC 19ç‚¹ = åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹ï¼ˆUTC+8ï¼‰

# ğŸš« ä¸å›  push/pull_request è§¦å‘
# âš ï¸ ä¿®æ”¹æœ¬æ–‡ä»¶æ—¶ GitHub ä¼šè‡ªåŠ¨éªŒè¯ä¸€æ¬¡ï¼Œè¿™å±äºç³»ç»Ÿè¡Œä¸ºæ— æ³•å…³é—­
#   push:
#     paths-ignore:
#       - '**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å‘å¸ƒ release éœ€è¦å†™æƒé™
      actions: read

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§± Prepare directories
        run: |
          mkdir -p openwrt/bin openwrt/files release/openwrt
          sudo chmod -R 777 openwrt/bin openwrt/files release/openwrt

      - name: ğŸ“¥ Download prebuilt rootfs
        working-directory: openwrt
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„æ„å»º rootfs æ–‡ä»¶..."
          ROOTFS_URL="https://dl.openwrt.ai/releases/targets/amlogic/meson8b/kwrt-10.30.2025-amlogic-meson8b-thunder-onecloud-rootfs.tar.gz"
          mkdir -p bin/rootfs
          cd bin/rootfs
          curl -LO "$ROOTFS_URL"
          echo "âœ… ä¸‹è½½å®Œæˆï¼š$(ls -lh)"

      - name: ğŸ“‚ Extract rootfs and apply configs
        working-directory: openwrt
        run: |
          echo "ğŸ“‚ è§£å‹ rootfs..."
          mkdir -p files/
          tar -xzf bin/rootfs/*.tar.gz -C files/ || true

          echo "ğŸ§° å†™å…¥æ—è·¯ç”±ç½‘ç»œé…ç½®..."
          mkdir -p files/etc/config

          cat <<'NETCONF' > files/etc/config/network
config interface 'lan'
  option proto 'static'
  option ipaddr '192.168.2.2'
  option netmask '255.255.255.0'
  option gateway '192.168.2.1'
  option dns '192.168.2.1'
NETCONF

          cat <<'DHCP' > files/etc/config/dhcp
config dhcp 'lan'
  option ignore '1'
DHCP

          echo "âœ… å·²é…ç½®æ—è·¯ç”±å‚æ•°ï¼ˆIP=192.168.2.2 ç½‘å…³=192.168.2.1 DHCP=å…³é—­ï¼‰"

      - name: ğŸ”§ Package customized firmware
        working-directory: openwrt
        run: |
          echo "ğŸ”§ æ‰“åŒ…å›ºä»¶..."
          mkdir -p ../release/openwrt
          tar -czf ../release/openwrt/thunder-onecloud-custom-rootfs.tar.gz -C files/ .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼šrelease/openwrt/thunder-onecloud-custom-rootfs.tar.gz"

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thunder-onecloud-rootfs-custom
          path: release/openwrt/
          if-no-files-found: warn
          compression-level: 6

      - name: ğŸ•’ Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "tag=$(date '+%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: ğŸš€ Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        if: always()
        with:
          tag_name: OneCloud-OpenWRT-${{ steps.time.outputs.tag }}
          name: "OneCloud OpenWRT æ—è·¯ç”±å›ºä»¶ ${{ steps.time.outputs.tag }}"
          body: |
            âœ… ç©å®¢äº‘ OneCloud OpenWRT å›ºä»¶æ„å»ºå®Œæˆï¼
            - å¹³å°: amlogic/meson8b
            - å†…æ ¸: 6.6.110
            - åŸºäº: openwrt.ai 24.10.4
            - æ„å»ºè€…: ${{ github.event.inputs.OP_author }}
            - æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: ${{ steps.time.outputs.datetime }}

            å›ºä»¶æ–‡ä»¶ï¼š
            ```
            thunder-onecloud-custom-rootfs.tar.gz
            ```
          files: release/openwrt/**/*
          overwrite_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
