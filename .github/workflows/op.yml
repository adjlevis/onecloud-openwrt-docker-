name: OneCloud OpenWRT è‡ªåŠ¨æ„å»ºçº¿åˆ·é•œåƒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ ä¿®æ­£æƒé™ä¸æ¢è¡Œç¬¦
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix
          dos2unix openwrt/*.sh
          chmod +x openwrt/*.sh

      - name: ğŸ§± æ‰§è¡Œæ„å»ºè„šæœ¬
        working-directory: ./openwrt
        env:
          OP_author: ${{ github.actor }}
          OP_rootfs: 512
        run: bash ./docker-build.sh

      - name: ğŸ“¦ ä¸Šä¼  EMMC çº¿åˆ·é•œåƒ
        uses: actions/upload-artifact@v4
        with:
          name: thunder-onecloud-emmc-ext4-img
          path: openwrt/release/openwrt/thunder-onecloud-emmc-ext4.img.gz

      # ğŸ§¹ åˆ é™¤æ—§çš„ Release å’Œ Tagï¼Œä¿æŒæœ€æ–°ç‰ˆæœ¬
      - name: ğŸ§¹ æ¸…ç†æ—§çš„ Releasesï¼ˆä»…ä¿ç•™æœ€æ–°1ä¸ªï¼‰
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ å‘å¸ƒæœ€æ–°çº¿åˆ·é•œåƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "OneCloud OpenWRT çº¿åˆ·åŒ…"
          body: |
            ğŸ”„ è‡ªåŠ¨æ„å»ºæ—¶é—´ï¼š${{ github.run_started_at }}
            âœ… å›ºä»¶ç±»å‹ï¼šEMMC çº¿åˆ·é•œåƒï¼ˆEXT4ï¼‰
            âš™ï¸ ä»…ä¿ç•™æœ€æ–°æ„å»ºç‰ˆæœ¬
          files: |
            openwrt/release/openwrt/thunder-onecloud-emmc-ext4.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
